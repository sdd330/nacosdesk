# 健康检查 API 测试用例

> **测试文件**: `src-tauri/src/server/tests/health_tests.rs`

---

## 1. 配置服务健康检查 (`GET /v1/cs/health`)

### 1.1 基础功能测试

#### 测试用例：返回状态为 UP
- **测试函数名**: `test_config_service_health_up`
- **前置条件**: 创建测试数据库（服务正常运行）
- **请求**:
  - 方法: `GET`
  - URI: `/nacos/v1/cs/health`
- **预期响应**:
  - 状态码: `200 OK`
  - 响应体: `{"status":"UP"}` 或 `"UP"`（根据实现）
- **验证点**:
  - 响应状态码为 200
  - 响应体表示服务状态为 UP

#### 测试用例：响应格式正确
- **测试函数名**: `test_config_service_health_format`
- **验证点**: 
  - 响应格式符合预期（JSON 或纯文本）
  - 包含必要的状态信息

---

## 2. 命名服务健康检查 (`GET /v1/ns/health`)

### 2.1 基础功能测试

#### 测试用例：返回状态为 UP
- **测试函数名**: `test_naming_service_health_up`
- **前置条件**: 创建测试数据库（服务正常运行）
- **请求**:
  - 方法: `GET`
  - URI: `/nacos/v1/ns/health`
- **预期响应**:
  - 状态码: `200 OK`
  - 响应体: `{"status":"UP"}` 或 `"UP"`（根据实现）
- **验证点**:
  - 响应状态码为 200
  - 响应体表示服务状态为 UP

#### 测试用例：响应格式正确
- **测试函数名**: `test_naming_service_health_format`
- **验证点**: 
  - 响应格式符合预期（JSON 或纯文本）
  - 包含必要的状态信息

---

## 3. 服务器健康检查 (`GET /v1/console/server/health`)

### 3.1 基础功能测试

#### 测试用例：服务器运行状态
- **测试函数名**: `test_server_health_running`
- **前置条件**: 创建测试数据库（服务器正常运行）
- **请求**:
  - 方法: `GET`
  - URI: `/nacos/v1/console/server/health`
- **预期响应**:
  - 状态码: `200 OK`
  - 响应体: JSON 格式，包含服务器状态信息
- **验证点**:
  - 响应状态码为 200
  - 服务器状态为 UP 或 RUNNING

#### 测试用例：包含监控指标信息
- **测试函数名**: `test_server_health_includes_metrics`
- **验证点**: 响应包含：
  - 服务器状态
  - 内存使用情况（可选）
  - CPU 使用情况（可选）
  - 其他监控指标（根据实现）

#### 测试用例：服务器停止时状态为 DOWN
- **测试函数名**: `test_server_health_down`
- **注意**: 此测试可能需要模拟服务器停止状态，或在实际停止时测试
- **预期响应**: 
  - 状态码: `503 Service Unavailable` 或 `200 OK`（状态为 DOWN）
  - 响应体: `{"status":"DOWN"}` 或类似
- **验证点**: 状态正确反映服务器状态

---

## 4. 服务器指标 API (`GET /v1/console/server/metrics`)

### 4.1 基础功能测试

#### 测试用例：获取请求统计信息
- **测试函数名**: `test_server_metrics_request_stats`
- **前置条件**: 
  - 创建测试数据库
  - 发送一些 API 请求（生成统计数据）
- **请求**:
  - 方法: `GET`
  - URI: `/nacos/v1/console/server/metrics`
- **预期响应**:
  - 状态码: `200 OK`
  - 响应体: JSON 格式，包含请求统计信息
- **验证点**:
  - 响应状态码为 200
  - 包含请求总数、成功数、失败数等统计信息

#### 测试用例：获取性能监控信息（内存、CPU）
- **测试函数名**: `test_server_metrics_performance`
- **验证点**: 响应包含：
  - 内存使用情况（已用、总量、百分比）
  - CPU 使用情况（百分比）
  - 其他性能指标（根据实现）

#### 测试用例：指标数据准确性
- **测试函数名**: `test_server_metrics_accuracy`
- **步骤**:
  1. 记录初始指标值
  2. 执行一些操作（例如：创建配置、注册服务）
  3. 再次查询指标
  4. 验证指标值的变化
- **验证点**: 指标值正确反映系统状态

---

## 📝 测试实现注意事项

1. **测试数据准备**:
   - 使用 `TestDatabase::new()` 创建测试数据库
   - 健康检查 API 通常不需要额外的测试数据

2. **请求构建**:
   - 健康检查 API 通常是简单的 GET 请求
   - 不需要认证（通常）

3. **响应验证**:
   - 验证状态码
   - 验证响应体格式和内容
   - 验证状态值的正确性

4. **清理**:
   - 健康检查测试通常不需要清理

5. **性能指标测试**:
   - 某些指标可能需要多次请求才能看到变化
   - 注意指标的实时性（可能有一定延迟）

6. **服务器状态模拟**:
   - 测试服务器停止状态可能需要特殊处理
   - 考虑使用 mock 或实际停止服务（谨慎使用）

---

**最后更新**: 2025-01-27

