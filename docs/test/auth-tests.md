# è®¤è¯ API æµ‹è¯•ç”¨ä¾‹

> **API è·¯å¾„å‰ç¼€**: `/nacos/v1/auth/users`  
> **æµ‹è¯•æ–‡ä»¶**: `src-tauri/src/server/tests/auth_tests.rs`

---

## 1. ç”¨æˆ·ç™»å½• API (`POST /v1/auth/users/login`)

### 1.1 åŸºç¡€åŠŸèƒ½æµ‹è¯•

#### æµ‹è¯•ç”¨ä¾‹ï¼šä½¿ç”¨æ­£ç¡®ç”¨æˆ·åå¯†ç ç™»å½•ï¼ˆæˆåŠŸï¼‰
- **æµ‹è¯•å‡½æ•°å**: `test_login_success`
- **å‰ç½®æ¡ä»¶**:
  - åˆ›å»ºæµ‹è¯•æ•°æ®åº“
  - æ’å…¥æµ‹è¯•ç”¨æˆ·ï¼š`username=nacos`, `password=nacos`ï¼ˆé»˜è®¤ç”¨æˆ·ï¼‰
- **è¯·æ±‚**:
  - æ–¹æ³•: `POST`
  - URI: `/nacos/v1/auth/users/login`
  - Headers: `Content-Type: application/x-www-form-urlencoded`
  - Body: `username=nacos&password=nacos`
- **é¢„æœŸå“åº”**:
  - çŠ¶æ€ç : `200 OK`
  - å“åº”ä½“: JSON æ ¼å¼ï¼ŒåŒ…å« `accessToken` å’Œ `tokenTtl` å­—æ®µ
- **éªŒè¯ç‚¹**:
  - å“åº”çŠ¶æ€ç ä¸º 200
  - è¿”å›æœ‰æ•ˆçš„ Token
  - Token æœ‰æ•ˆæœŸï¼ˆtokenTtlï¼‰æ­£ç¡®

#### æµ‹è¯•ç”¨ä¾‹ï¼šä½¿ç”¨é”™è¯¯å¯†ç ç™»å½•ï¼ˆ401ï¼‰
- **æµ‹è¯•å‡½æ•°å**: `test_login_wrong_password`
- **å‰ç½®æ¡ä»¶**: æ’å…¥æµ‹è¯•ç”¨æˆ·ï¼š`username=nacos`, `password=correct-password`
- **è¯·æ±‚**: Body: `username=nacos&password=wrong-password`
- **é¢„æœŸå“åº”**:
  - çŠ¶æ€ç : `401 Unauthorized`
  - å“åº”ä½“: é”™è¯¯æ¶ˆæ¯
- **éªŒè¯ç‚¹**: è¿”å› 401 çŠ¶æ€ç 

#### æµ‹è¯•ç”¨ä¾‹ï¼šä½¿ç”¨ä¸å­˜åœ¨çš„ç”¨æˆ·åç™»å½•ï¼ˆ401ï¼‰
- **æµ‹è¯•å‡½æ•°å**: `test_login_user_not_found`
- **å‰ç½®æ¡ä»¶**: åˆ›å»ºæµ‹è¯•æ•°æ®åº“ï¼ˆä¸æ’å…¥ç”¨æˆ·ï¼‰
- **è¯·æ±‚**: Body: `username=non-existent&password=any-password`
- **é¢„æœŸå“åº”**:
  - çŠ¶æ€ç : `401 Unauthorized`
  - å“åº”ä½“: é”™è¯¯æ¶ˆæ¯
- **éªŒè¯ç‚¹**: è¿”å› 401 çŠ¶æ€ç 

#### æµ‹è¯•ç”¨ä¾‹ï¼šç™»å½•è¿”å› Token
- **æµ‹è¯•å‡½æ•°å**: `test_login_returns_token`
- **å‰ç½®æ¡ä»¶**: æ’å…¥æµ‹è¯•ç”¨æˆ·
- **éªŒè¯ç‚¹**: 
  - å“åº”åŒ…å« `accessToken` å­—æ®µ
  - Token ä¸ä¸ºç©º
  - Token æ ¼å¼æ­£ç¡®ï¼ˆé€šå¸¸æ˜¯ JWT æˆ– UUIDï¼‰

#### æµ‹è¯•ç”¨ä¾‹ï¼šToken æœ‰æ•ˆæœŸï¼ˆtokenTtlï¼‰
- **æµ‹è¯•å‡½æ•°å**: `test_login_token_ttl`
- **å‰ç½®æ¡ä»¶**: æ’å…¥æµ‹è¯•ç”¨æˆ·
- **éªŒè¯ç‚¹**: 
  - å“åº”åŒ…å« `tokenTtl` å­—æ®µ
  - tokenTtl å€¼åˆç†ï¼ˆä¾‹å¦‚ 18000 ç§’ = 5 å°æ—¶ï¼‰

### 1.2 å‚æ•°éªŒè¯æµ‹è¯•

#### æµ‹è¯•ç”¨ä¾‹ï¼šç¼ºå°‘ç”¨æˆ·åæˆ–å¯†ç 
- **æµ‹è¯•å‡½æ•°å**: `test_login_missing_username`
- **è¯·æ±‚**: Body: `password=nacos`ï¼ˆç¼ºå°‘ usernameï¼‰
- **é¢„æœŸå“åº”**: `400 Bad Request`
- **éªŒè¯ç‚¹**: è¿”å›é”™è¯¯çŠ¶æ€ç 

#### æµ‹è¯•ç”¨ä¾‹ï¼šç¼ºå°‘å¯†ç 
- **æµ‹è¯•å‡½æ•°å**: `test_login_missing_password`
- **è¯·æ±‚**: Body: `username=nacos`ï¼ˆç¼ºå°‘ passwordï¼‰
- **é¢„æœŸå“åº”**: `400 Bad Request`
- **éªŒè¯ç‚¹**: è¿”å›é”™è¯¯çŠ¶æ€ç 

#### æµ‹è¯•ç”¨ä¾‹ï¼šè¡¨å•æ ¼å¼å’Œ JSON æ ¼å¼
- **æµ‹è¯•å‡½æ•°å**: `test_login_form_vs_json`
- **æµ‹è¯•åœºæ™¯**:
  1. `Content-Type: application/x-www-form-urlencoded` + `username=nacos&password=nacos`
  2. `Content-Type: application/json` + `{"username":"nacos","password":"nacos"}`
- **éªŒè¯ç‚¹**: ä¸¤ç§æ ¼å¼éƒ½åº”æ”¯æŒï¼ˆæ ¹æ®å®ç°ï¼‰

---

## 2. Token éªŒè¯æµ‹è¯•

### 2.1 Token ä½¿ç”¨æµ‹è¯•

#### æµ‹è¯•ç”¨ä¾‹ï¼šä½¿ç”¨æœ‰æ•ˆ Token è®¿é—®å—ä¿æŠ¤ APIï¼ˆæˆåŠŸï¼‰
- **æµ‹è¯•å‡½æ•°å**: `test_token_valid_access`
- **å‰ç½®æ¡ä»¶**:
  - æ’å…¥æµ‹è¯•ç”¨æˆ·
  - ç™»å½•è·å– Token
- **è¯·æ±‚**:
  - æ–¹æ³•: `GET`
  - URI: `/nacos/v1/auth/users`ï¼ˆéœ€è¦è®¤è¯çš„ APIï¼‰
  - Headers: `Authorization: Bearer <token>` æˆ– `accessToken: <token>`
- **é¢„æœŸå“åº”**: `200 OK`
- **éªŒè¯ç‚¹**: ä½¿ç”¨ Token å¯ä»¥æˆåŠŸè®¿é—®å—ä¿æŠ¤ API

#### æµ‹è¯•ç”¨ä¾‹ï¼šä½¿ç”¨æ— æ•ˆ Token è®¿é—®å—ä¿æŠ¤ APIï¼ˆ401ï¼‰
- **æµ‹è¯•å‡½æ•°å**: `test_token_invalid_access`
- **è¯·æ±‚**: ä½¿ç”¨æ— æ•ˆçš„ Tokenï¼ˆä¾‹å¦‚ï¼š`invalid-token-123`ï¼‰
- **é¢„æœŸå“åº”**: `401 Unauthorized`
- **éªŒè¯ç‚¹**: è¿”å› 401 çŠ¶æ€ç 

#### æµ‹è¯•ç”¨ä¾‹ï¼šä½¿ç”¨è¿‡æœŸ Token è®¿é—®å—ä¿æŠ¤ APIï¼ˆ401ï¼‰
- **æµ‹è¯•å‡½æ•°å**: `test_token_expired_access`
- **å‰ç½®æ¡ä»¶**: 
  - ç™»å½•è·å– Token
  - ç­‰å¾… Token è¿‡æœŸï¼ˆæˆ–æ‰‹åŠ¨è®¾ç½®è¿‡æœŸæ—¶é—´ï¼‰
- **è¯·æ±‚**: ä½¿ç”¨è¿‡æœŸçš„ Token
- **é¢„æœŸå“åº”**: `401 Unauthorized`
- **éªŒè¯ç‚¹**: è¿”å› 401 çŠ¶æ€ç 

#### æµ‹è¯•ç”¨ä¾‹ï¼šç¼ºå°‘ Token è®¿é—®å—ä¿æŠ¤ APIï¼ˆ401ï¼‰
- **æµ‹è¯•å‡½æ•°å**: `test_token_missing_access`
- **è¯·æ±‚**: ä¸åŒ…å« Authorization å¤´æˆ– accessToken å‚æ•°
- **é¢„æœŸå“åº”**: `401 Unauthorized`
- **éªŒè¯ç‚¹**: è¿”å› 401 çŠ¶æ€ç 

---

## 3. ç”¨æˆ·åˆ—è¡¨ API (`GET /v1/auth/users`)

### 3.1 åŸºç¡€åŠŸèƒ½æµ‹è¯•

#### æµ‹è¯•ç”¨ä¾‹ï¼šè·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆéœ€è¦è®¤è¯ï¼‰
- **æµ‹è¯•å‡½æ•°å**: `test_list_users_success`
- **å‰ç½®æ¡ä»¶**:
  - æ’å…¥å¤šä¸ªæµ‹è¯•ç”¨æˆ·
  - ç™»å½•è·å– Token
- **è¯·æ±‚**:
  - æ–¹æ³•: `GET`
  - URI: `/nacos/v1/auth/users`
  - Headers: `Authorization: Bearer <token>` æˆ– `accessToken: <token>`
- **é¢„æœŸå“åº”**:
  - çŠ¶æ€ç : `200 OK`
  - å“åº”ä½“: JSON æ ¼å¼ï¼ŒåŒ…å«ç”¨æˆ·åˆ—è¡¨
- **éªŒè¯ç‚¹**:
  - å“åº”çŠ¶æ€ç ä¸º 200
  - è¿”å›æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯
  - ç”¨æˆ·ä¿¡æ¯åŒ…å«ï¼šusername, enabled ç­‰å­—æ®µ

#### æµ‹è¯•ç”¨ä¾‹ï¼šæœªè®¤è¯è®¿é—®ï¼ˆ401ï¼‰
- **æµ‹è¯•å‡½æ•°å**: `test_list_users_unauthorized`
- **è¯·æ±‚**: ä¸åŒ…å«è®¤è¯ä¿¡æ¯
- **é¢„æœŸå“åº”**: `401 Unauthorized`
- **éªŒè¯ç‚¹**: è¿”å› 401 çŠ¶æ€ç 

#### æµ‹è¯•ç”¨ä¾‹ï¼šç”¨æˆ·åˆ—è¡¨ä¿¡æ¯å®Œæ•´æ€§
- **æµ‹è¯•å‡½æ•°å**: `test_list_users_complete_info`
- **éªŒè¯ç‚¹**: ç”¨æˆ·åˆ—è¡¨åŒ…å«ï¼š
  - ç”¨æˆ·åï¼ˆusernameï¼‰
  - å¯ç”¨çŠ¶æ€ï¼ˆenabledï¼‰
  - åˆ›å»ºæ—¶é—´ï¼ˆå¯é€‰ï¼‰
  - å…¶ä»–ç”¨æˆ·ä¿¡æ¯ï¼ˆæ ¹æ®å®ç°ï¼‰

---

## ğŸ“ æµ‹è¯•å®ç°æ³¨æ„äº‹é¡¹

1. **æµ‹è¯•æ•°æ®å‡†å¤‡**:
   - ä½¿ç”¨ `TestDatabase::new()` åˆ›å»ºæµ‹è¯•æ•°æ®åº“
   - ä½¿ç”¨ `insert_test_user()` æ’å…¥æµ‹è¯•ç”¨æˆ·
   - é»˜è®¤ç”¨æˆ· `nacos/nacos` é€šå¸¸å·²å­˜åœ¨

2. **å¯†ç å“ˆå¸Œ**:
   - å¯†ç åœ¨æ•°æ®åº“ä¸­å­˜å‚¨ä¸ºå“ˆå¸Œå€¼ï¼ˆBCryptï¼‰
   - æµ‹è¯•æ—¶ä½¿ç”¨æ­£ç¡®çš„å“ˆå¸Œå€¼ï¼š`$2a$10$EuWPZHzz32dJN7jexM34MOeYirDdFAZm2kuWj7VEOJhhZkDrxfvUu`ï¼ˆå¯¹åº” "nacos"ï¼‰

3. **Token æ ¼å¼**:
   - Token å¯èƒ½å­˜å‚¨åœ¨ `tokens` è¡¨ä¸­
   - Token æ ¼å¼å¯èƒ½æ˜¯ JWT æˆ– UUID
   - æ³¨æ„ Token çš„è¿‡æœŸæ—¶é—´éªŒè¯

4. **è¯·æ±‚æ„å»º**:
   - ç™»å½•è¯·æ±‚ä½¿ç”¨è¡¨å•æ ¼å¼ï¼ˆ`application/x-www-form-urlencoded`ï¼‰
   - å—ä¿æŠ¤ API éœ€è¦åœ¨ Header æˆ–å‚æ•°ä¸­ä¼ é€’ Token

5. **å“åº”éªŒè¯**:
   - éªŒè¯çŠ¶æ€ç 
   - éªŒè¯å“åº”ä½“æ ¼å¼å’Œå†…å®¹
   - éªŒè¯ Token çš„æœ‰æ•ˆæ€§ï¼ˆå¯é€‰ï¼‰

6. **æ¸…ç†**:
   - ä½¿ç”¨ `test_db.cleanup()` æ¸…ç†æµ‹è¯•æ•°æ®
   - æ³¨æ„æ¸…ç† tokens è¡¨

---

**æœ€åæ›´æ–°**: 2025-01-27

