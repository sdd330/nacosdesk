# Nacos API 测试补充任务列表

> **文档版本**: v1.0  
> **创建日期**: 2025-01-27  
> **状态**: 🚧 进行中

---

## 📋 概述

本文档列出了需要补充的 Nacos Standalone API 集成测试用例。测试框架已建立（`src-tauri/src/server/tests/`），现在需要补充完整的测试用例覆盖所有 API 端点。

---

## 🎯 测试目标

- ✅ 确保所有 API 端点功能正常
- ✅ 验证 API 响应格式与 nacos-develop 保持一致
- ✅ 覆盖正常流程和异常流程
- ✅ 提高代码测试覆盖率

---

## 📝 待补充测试用例

### 1. 配置管理 API 测试

#### 1.1 配置发布 API (`POST /v1/cs/configs`)
- [ ] **基础功能测试**
  - [ ] 测试发布新配置（成功）
  - [ ] 测试更新已存在配置（成功）
  - [ ] 测试不同配置格式（TEXT、JSON、YAML、XML、Properties）
  - [ ] 测试不同命名空间（public、自定义命名空间）
  - [ ] 测试不同 Group（DEFAULT_GROUP、自定义 Group）
- [ ] **参数验证测试**
  - [ ] 测试缺少必需参数（dataId、group、content）
  - [ ] 测试无效的命名空间 ID
  - [ ] 测试超长配置内容
- [ ] **边界情况测试**
  - [ ] 测试空配置内容
  - [ ] 测试特殊字符处理
  - [ ] 测试中文内容

#### 1.2 配置获取 API (`GET /v1/cs/configs`)
- [ ] **基础功能测试**
  - [ ] 测试获取存在的配置（成功）
  - [ ] 测试获取不存在的配置（404）
  - [ ] 测试不同命名空间和 Group
  - [ ] 测试 show=all 参数（返回详细信息）
- [ ] **MD5 验证测试**
  - [ ] 测试配置 MD5 值正确性
  - [ ] 测试配置更新后 MD5 变化

#### 1.3 配置删除 API (`DELETE /v1/cs/configs`)
- [ ] **基础功能测试**
  - [ ] 测试删除存在的配置（成功）
  - [ ] 测试删除不存在的配置（404）
  - [ ] 测试删除后配置历史记录保留

#### 1.4 配置监听 API (`POST /v1/cs/configs/listener`)
- [ ] **长轮询测试**
  - [ ] 测试配置无变更时超时返回（30秒）
  - [ ] 测试配置变更时立即返回
  - [ ] 测试监听多个配置
  - [ ] 测试 MD5 值匹配和不匹配的情况
- [ ] **参数验证测试**
  - [ ] 测试无效的 Listening-Configs 格式
  - [ ] 测试 Long-Pulling-Timeout 参数

#### 1.5 配置监听者查询 API (`GET /v1/cs/configs/listener`)
- [ ] **基础功能测试**
  - [ ] 测试查询配置的监听者列表
  - [ ] 测试无监听者时返回空列表
  - [ ] 测试多个客户端监听同一配置

#### 1.6 配置历史记录 API (`GET /v1/cs/history`)
- [ ] **基础功能测试**
  - [ ] 测试获取配置历史记录列表
  - [ ] 测试历史记录按时间排序
  - [ ] 测试分页参数（pageNo、pageSize）
  - [ ] 测试历史记录详情（操作类型、操作人、操作时间）

#### 1.7 配置目录 API (`GET /v1/cs/configs/catalog`)
- [ ] **基础功能测试**
  - [ ] 测试获取配置目录（搜索功能）
  - [ ] 测试精确搜索（search=accurate）
  - [ ] 测试模糊搜索（search=blur）
  - [ ] 测试按应用名称过滤
  - [ ] 测试按配置类型过滤
  - [ ] 测试分页功能

#### 1.8 配置回滚 API (`POST /v3/console/cs/config/rollback`)
- [ ] **基础功能测试**
  - [ ] 测试回滚到指定历史版本
  - [ ] 测试回滚后配置内容正确
  - [ ] 测试回滚后历史记录更新
  - [ ] 测试回滚不存在的版本（错误处理）

---

### 2. 服务管理 API 测试

#### 2.1 服务列表 API (`GET /v1/ns/service/list`)
- [ ] **基础功能测试**
  - [ ] 测试获取服务列表（成功）
  - [ ] 测试分页功能（pageNo、pageSize）
  - [ ] 测试不同命名空间的服务列表
  - [ ] 测试不同 Group 的服务列表
  - [ ] 测试空列表返回
- [ ] **参数验证测试**
  - [ ] 测试无效的分页参数
  - [ ] 测试无效的命名空间 ID

#### 2.2 服务详情 API (`GET /v1/ns/service`)
- [ ] **基础功能测试**
  - [ ] 测试获取存在的服务详情（成功）
  - [ ] 测试获取不存在的服务（404）
  - [ ] 测试服务详情包含实例列表
  - [ ] 测试服务元数据信息

#### 2.3 服务创建 API (`POST /v1/ns/service`)
- [ ] **基础功能测试**
  - [ ] 测试创建新服务（成功）
  - [ ] 测试创建已存在的服务（错误处理）
  - [ ] 测试服务元数据设置
  - [ ] 测试保护阈值设置

#### 2.4 服务更新 API (`PUT /v1/ns/service`)
- [ ] **基础功能测试**
  - [ ] 测试更新服务元数据
  - [ ] 测试更新保护阈值
  - [ ] 测试更新不存在的服务（404）

#### 2.5 服务删除 API (`DELETE /v1/ns/service`)
- [ ] **基础功能测试**
  - [ ] 测试删除存在的服务（成功）
  - [ ] 测试删除不存在的服务（404）
  - [ ] 测试删除服务后实例也被删除

#### 2.6 服务名搜索 API (`GET /v1/ns/service/names`)
- [ ] **基础功能测试**
  - [ ] 测试搜索服务名（模糊匹配）
  - [ ] 测试搜索不存在的服务名（空结果）
  - [ ] 测试分页功能

#### 2.7 服务订阅者列表 API (`GET /v1/ns/service/subscribers`)
- [ ] **基础功能测试**
  - [ ] 测试获取服务的订阅者列表
  - [ ] 测试无订阅者时返回空列表
  - [ ] 测试多个订阅者的情况

---

### 3. 实例管理 API 测试

#### 3.1 实例注册 API (`POST /v1/ns/instance`)
- [ ] **基础功能测试**
  - [ ] 测试注册新实例（成功）
  - [ ] 测试注册已存在的实例（更新）
  - [ ] 测试不同命名空间和 Group
  - [ ] 测试实例元数据设置
  - [ ] 测试实例权重设置
  - [ ] 测试临时实例和持久实例
- [ ] **参数验证测试**
  - [ ] 测试缺少必需参数（ip、port、serviceName）
  - [ ] 测试无效的 IP 地址
  - [ ] 测试无效的端口号
  - [ ] 测试无效的权重值

#### 3.2 实例更新 API (`PUT /v1/ns/instance`)
- [ ] **基础功能测试**
  - [ ] 测试更新实例信息（权重、元数据、健康状态）
  - [ ] 测试更新不存在的实例（404）
  - [ ] 测试更新后实例信息正确

#### 3.3 实例注销 API (`DELETE /v1/ns/instance`)
- [ ] **基础功能测试**
  - [ ] 测试注销存在的实例（成功）
  - [ ] 测试注销不存在的实例（404）
  - [ ] 测试注销后实例从服务中移除

#### 3.4 实例查询 API (`GET /v1/ns/instance`)
- [ ] **基础功能测试**
  - [ ] 测试查询存在的实例（成功）
  - [ ] 测试查询不存在的实例（404）
  - [ ] 测试实例详情信息完整性

#### 3.5 实例列表 API (`GET /v1/ns/instance/list`)
- [ ] **基础功能测试**
  - [ ] 测试获取服务的实例列表
  - [ ] 测试过滤健康实例
  - [ ] 测试过滤不健康实例
  - [ ] 测试空实例列表

#### 3.6 实例心跳 API (`PUT /v1/ns/instance/beat`)
- [ ] **基础功能测试**
  - [ ] 测试发送心跳（成功）
  - [ ] 测试心跳更新实例最后心跳时间
  - [ ] 测试心跳保持实例健康状态
  - [ ] 测试心跳不存在的实例（错误处理）

#### 3.7 实例部分更新 API (`PATCH /v1/ns/instance`)
- [ ] **基础功能测试**
  - [ ] 测试部分更新实例元数据
  - [ ] 测试部分更新实例权重
  - [ ] 测试部分更新实例健康状态

#### 3.8 实例批量操作 API
- [ ] **批量更新元数据** (`PUT /v1/ns/instance/metadata/batch`)
  - [ ] 测试批量更新多个实例的元数据
  - [ ] 测试部分实例不存在的情况
- [ ] **批量删除元数据** (`DELETE /v1/ns/instance/metadata/batch`)
  - [ ] 测试批量删除多个实例的元数据
  - [ ] 测试删除不存在的元数据键

#### 3.9 实例状态查询 API (`GET /v1/ns/instance/statuses`)
- [ ] **基础功能测试**
  - [ ] 测试获取多个实例的健康状态
  - [ ] 测试状态信息准确性

---

### 4. 命名空间管理 API 测试

#### 4.1 命名空间列表 API (`GET /v1/console/namespaces`)
- [ ] **基础功能测试**
  - [ ] 测试获取命名空间列表
  - [ ] 测试包含默认 public 命名空间
  - [ ] 测试多个命名空间的情况

#### 4.2 命名空间创建 API (`POST /v1/console/namespaces`)
- [ ] **基础功能测试**
  - [ ] 测试创建新命名空间（成功）
  - [ ] 测试创建已存在的命名空间（错误处理）
  - [ ] 测试命名空间名称和描述设置

#### 4.3 命名空间更新 API (`PUT /v1/console/namespaces`)
- [ ] **基础功能测试**
  - [ ] 测试更新命名空间信息
  - [ ] 测试更新不存在的命名空间（404）

#### 4.4 命名空间删除 API (`DELETE /v1/console/namespaces`)
- [ ] **基础功能测试**
  - [ ] 测试删除命名空间（成功）
  - [ ] 测试删除不存在的命名空间（404）
  - [ ] 测试删除命名空间后配置和服务也被删除
  - [ ] 测试删除 public 命名空间（错误处理）

---

### 5. 认证 API 测试

#### 5.1 用户登录 API (`POST /v1/auth/users/login`)
- [ ] **基础功能测试**
  - [ ] 测试使用正确用户名密码登录（成功）
  - [ ] 测试使用错误密码登录（401）
  - [ ] 测试使用不存在的用户名登录（401）
  - [ ] 测试登录返回 Token
  - [ ] 测试 Token 有效期（tokenTtl）
- [ ] **参数验证测试**
  - [ ] 测试缺少用户名或密码
  - [ ] 测试表单格式和 JSON 格式

#### 5.2 Token 验证测试
- [ ] **Token 使用测试**
  - [ ] 测试使用有效 Token 访问受保护 API（成功）
  - [ ] 测试使用无效 Token 访问受保护 API（401）
  - [ ] 测试使用过期 Token 访问受保护 API（401）
  - [ ] 测试缺少 Token 访问受保护 API（401）

#### 5.3 用户列表 API (`GET /v1/auth/users`)
- [ ] **基础功能测试**
  - [ ] 测试获取用户列表（需要认证）
  - [ ] 测试未认证访问（401）
  - [ ] 测试用户列表信息完整性

---

### 6. 健康检查 API 测试

#### 6.1 配置服务健康检查 (`GET /v1/cs/health`)
- [ ] **基础功能测试**
  - [ ] 测试返回状态为 UP
  - [ ] 测试响应格式正确

#### 6.2 命名服务健康检查 (`GET /v1/ns/health`)
- [ ] **基础功能测试**
  - [ ] 测试返回状态为 UP
  - [ ] 测试响应格式正确

#### 6.3 服务器健康检查 (`GET /v1/console/server/health`)
- [ ] **基础功能测试**
  - [ ] 测试服务器运行状态
  - [ ] 测试包含监控指标信息
  - [ ] 测试服务器停止时状态为 DOWN

#### 6.4 服务器指标 API (`GET /v1/console/server/metrics`)
- [ ] **基础功能测试**
  - [ ] 测试获取请求统计信息
  - [ ] 测试获取性能监控信息（内存、CPU）
  - [ ] 测试指标数据准确性

---

### 7. 集成测试场景

#### 7.1 配置管理完整流程
- [ ] **完整流程测试**
  - [ ] 测试创建配置 → 获取配置 → 更新配置 → 监听配置变更 → 删除配置
  - [ ] 测试配置历史记录和回滚流程
  - [ ] 测试配置导入导出流程

#### 7.2 服务管理完整流程
- [ ] **完整流程测试**
  - [ ] 测试创建服务 → 注册实例 → 查询服务 → 更新实例 → 注销实例 → 删除服务
  - [ ] 测试服务发现流程
  - [ ] 测试实例健康检查和心跳流程

#### 7.3 跨模块集成测试
- [ ] **跨模块测试**
  - [ ] 测试命名空间创建 → 配置管理 → 服务管理（命名空间隔离）
  - [ ] 测试用户登录 → 配置管理 → 服务管理（认证流程）
  - [ ] 测试配置变更 → 服务实例监听（配置监听流程）

---

## 📊 测试覆盖率目标

- **配置管理 API**: 目标 90%+
- **服务管理 API**: 目标 90%+
- **实例管理 API**: 目标 90%+
- **命名空间管理 API**: 目标 90%+
- **认证 API**: 目标 90%+
- **健康检查 API**: 目标 100%

---

## 🛠️ 测试工具和框架

- **测试框架**: Rust 标准测试框架 + tokio
- **HTTP 客户端**: tower ServiceExt
- **数据库**: SQLite（临时数据库）
- **测试辅助**: `src-tauri/src/server/tests/db_setup.rs`

---

## 📝 测试编写规范

### 测试文件结构
```
src-tauri/src/server/tests/
├── mod.rs                    # 测试模块声明
├── db_setup.rs              # 数据库设置辅助
├── helpers.rs              # 测试辅助函数
├── integration_tests.rs    # 集成测试（已有基础）
├── config_tests.rs         # 配置管理 API 测试
├── service_tests.rs        # 服务管理 API 测试
├── instance_tests.rs       # 实例管理 API 测试
├── namespace_tests.rs      # 命名空间管理 API 测试
├── auth_tests.rs           # 认证 API 测试
└── health_tests.rs         # 健康检查 API 测试
```

### 测试命名规范
- 测试函数名：`test_<api_name>_<scenario>`
- 例如：`test_publish_config_success`, `test_get_config_not_found`

### 测试结构
```rust
#[tokio::test]
async fn test_<api_name>_<scenario>() {
    // 1. 创建测试数据库
    let test_db = TestDatabase::new().await.unwrap();
    
    // 2. 插入测试数据
    test_db.insert_test_xxx().await.unwrap();
    
    // 3. 创建路由并发送请求
    let router = create_router("/nacos".to_string(), test_db.app.clone());
    let request = Request::builder()...;
    let response = router.oneshot(request).await.unwrap();
    
    // 4. 验证响应
    assert_eq!(response.status(), StatusCode::OK);
    // 验证响应体内容...
    
    // 5. 清理（可选）
    test_db.cleanup().await.unwrap();
}
```

---

## 🎯 优先级

### 🔴 高优先级（核心功能）
1. 配置管理 API（发布、获取、删除、监听）
2. 服务管理 API（列表、详情、CRUD）
3. 实例管理 API（注册、查询、心跳）
4. 认证 API（登录、Token 验证）

### 🟡 中优先级（增强功能）
1. 配置历史记录和回滚
2. 实例批量操作
3. 命名空间管理完整流程

### 🟢 低优先级（辅助功能）
1. 健康检查 API
2. 服务器监控 API
3. 集成测试场景

---

## 📈 进度跟踪

- **总任务数**: 约 150+ 个测试用例
- **已完成**: 5 个（基础示例）
- **进行中**: 0 个
- **待完成**: 150+ 个

---

## 📚 参考文档

- [测试框架文档](src-tauri/src/server/tests/README.md)
- [Nacos 官方 API 文档](https://nacos.io/docs/latest/)
- [nacos-develop 测试用例](https://github.com/alibaba/nacos/tree/develop/test)

---

**最后更新**: 2025-01-27

